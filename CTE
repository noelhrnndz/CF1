# Find the average amount paid by the top 5 customers using CTE

WITH average_amount_cte (customer_id, first_name, last_name, city, country) AS
	(SELECT
		A.customer_id,
		A.first_name,
		A.last_name,
		D.country,
		C.city,
		SUM(B.amount) AS total_amount_paid
	FROM customer A
	JOIN payment B ON A.customer_id = B.customer_id
	JOIN address E ON A.address_id = E.address_id
	JOIN city C ON E.city_id = C.city_id
	JOIN country D ON C.country_id = D.country_id
	WHERE C.city IN (
		SELECT city
		FROM customer A
		JOIN address E ON A.address_id = E.address_id
		JOIN city C ON E.city_id = D.country_id
		GROUP BY C.city
		ORDER BY COUNT(A.customer_id) DESC
		LIMIT 10
		)
GROUP BY A.customer_id, A.first_name, A.last_name, D.country, C.city
ORDER BY total_amount_paid DESC
LIMIT 5)
SELECT AVG(total_amount_paid) AS average
FROM average_amount_cte

![Screenshot of avg returned](![image](https://github.com/noelhrnndz/SQL_Project_Rockbuster/assets/147015154/6e1c07ea-a65c-4c85-a62f-de6d92cf6898)
)
